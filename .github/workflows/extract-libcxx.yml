name: Extract libc++ assets

on:
  schedule:
    - cron: "0 6 * * 0"   # Every Sunday 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Copy aarch64 → arm64-v8a
        run: |
          cp -a libc++/aarch64/data/data/com.termux/files/usr/lib arm64-v8a/
          cp -a libc++/aarch64/data/data/com.termux/files/usr/share arm64-v8a/

      - name: Copy arm → armeabi-v7a
        run: |
          cp -a libc++/arm/data/data/com.termux/files/usr/lib armeabi-v7a/
          cp -a libc++/arm/data/data/com.termux/files/usr/share armeabi-v7a/

      - name: Copy i686 → x86
        run: |
          cp -a libc++/i686/data/data/com.termux/files/usr/lib x86/
          cp -a libc++/i686/data/data/com.termux/files/usr/share x86/

      - name: Copy x86_64 → x86_64
        run: |
          cp -a libc++/x86_64/data/data/com.termux/files/usr/lib x86_64/
          cp -a libc++/x86_64/data/data/com.termux/files/usr/share x86_64/

      - name: Commit and push extracted libc++ assets
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          if [ -n "$(git status --porcelain arm64-v8a armeabi-v7a x86 x86_64)" ]; then
            git add arm64-v8a armeabi-v7a x86 x86_64
            git commit -m "Extracted libc++ assets into ABI directories"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
          else
            echo "No updates found."
          fi
